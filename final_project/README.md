# Виртуальный L2 свитч

## Цель проекта

Реализовать программно основной функционал Ethernet коммутатора 2-го уровня и виртуальных портов,
позволяющих подключаться к нему любому сетевому устройству.

## Задачи
1. Создать виртуальный порт, перенаправляющий траффик с TAP устройства в сетевой сокет.
2. Разработать симулятор коммутатора 2-го уровня.
3. Добавить работу в режиме демона.
4. Реализовать дополнительный функционал (интерфейс командной строки, VLAN).

## Основные функции коммутатора второго уровня

L2 switch работает на втором уровне сетевой модели OSI, пересылая кадры Ethernet, не анализируя их содержимого.
В основе его работы лежит таблица MAC адресов.

Алгоритм работы состоит из трёх частей:
 * MAC learning;
 * MAC forwarding;
 * MAC aging.

### MAC learning
При поступлении на входной порт фрейма таблица MAC адресов просматривается, и если адрес источника неизвестен, то в он сохраняется
вместе с номером порта. Помимо MAC адреса и номера порта сохраняется временная отметка, а также может записываться и другая информация (тип записи (статическая/динамическая), таг VLAN и пр.).

Если же адрес источника известен, то соответствующая временная отметка обновляется.

### MAC forwarding
Пересылка кадров. Свитч просматривает таблицу MAC адресов в поисках адреса назначения. Если таковой найден, то кадр пересылается 
соответствующий порт. Если же адрес назначения неизвестен, то свитч пересылает кадр во все порты, кроме исходного (то же делается в случае, если вместо получателя указан широковещательный адрес). В случае если адрес назначения совпадает с источником (фрейм адресован нам), то ничего не происходит

### MAC aging
Чтобы в таблице MAC адресов оставались только актуальные записи, свитч периодически просматривает её и удаляет строки старше
определённого времени.


## Виртуальное сетевое устройство: TAP
TAP — это тип виртуального сетевого устройства, которое может имитировать физический сетевой интерфейс, позволяя операционным системам и приложениям использовать его как физический интерфейс. Устройства TAP обычно используются для создания соединений виртуальной частной сети (VPN) между различными компьютерами для безопасной передачи данных по сетям общего пользования.

Устройство TAP реализовано в ядре операционной системы. Оно выглядит как обычный сетевой интерфейс и может использоваться в приложениях как обычная физическая сетевая карта. Когда пакеты отправляются через устройство TAP, они передаются драйверу TUN/TAP в ядре, который передает пакеты пользовательскому процессу. Приложение может обрабатывать пакеты и передавать их другим устройствам или сетям. Аналогично, когда приложения отправляют пакеты, они передаются драйверу TUN/TAP, который пересылает их на указанное целевое устройство или сеть.

Мы будем использовать TAP для соединения клиентских компьютеров и виртуального коммутатора.

## Архитектура системы
Состоит из сервера (**VSwitch**) и нескольких клиентов (**VPort**s)

Сервер (**VSwitch**) имитирует поведение физического сетевого коммутатора, предоставляя службу обмена кадрами Ethernet для каждого компьютера, подключенного к VSwitch через VPorts.
Поддерживает таблицу MAC-адресов для пересылки Ethernet фреймов.
|MAC|VPort|
|--|--|
11:11:11:11:11:11 | VPort-1
aa:aa:aa:aa:aa:aa | VPort-a

Клиент (**VPort**) имитирует поведение порта физического коммутатора, отвечая за ретрансляцию кадров Ethernet между коммутатором и компьютером. Один конец подключен к компьютеру (ядру Linux) через устройство TAP, другой подключён к VSwitch через сокет UDP.

```
    +----------------------------------------------+
    |                   VSwitch                    |
    |                                              |
    |     +----------------+---------------+       |
    |     |            MAC Table           |       |
    |     |--------------------------------+       |
    |     |      MAC       |      VPort    |       |
    |     |--------------------------------+       |
    |     | 11:11:11:11:11 |   VClient-1   |       |
    |     |--------------------------------+       |
    |     | aa:aa:aa:aa:aa |   VClient-a   |       |
    |     +----------------+---------------+       |
    |                                              |
    |           ^                       ^          |
    +-----------|-----------------------|----------+
        +-------|--------+     +--------|-------+
        |       v        |     |        v       |
        | +------------+ |     | +------------+ |
        | | UDP Socket | |     | | UDP Socket | |
        | +------------+ |     | +------------+ |
        |       ^        |     |        ^       |
        |       |        |     |        |       |
        |(Ethernet Frame)|     |(Ethernet Frame)|
        |       |        |     |        |       |
  VPort |       v        |     |        v       | VPort
        | +------------+ |     | +------------+ |
        | | TAP Device | |     | | TAP Device | |
        | +------------+ |     | +------------+ |
        |       ^        |     |        ^       |
        +-------|--------+     +--------|-------+
                v                       v
  -------------------------   -------------------------
  Computer A's Linux Kernel   Computer B's Linux Kernel
```

## Исходный код

1. [`v_switch.c`](./v_switch.cy): код для **VSwitch**
2. [`vы_port.c`](./ы_vport.c): код для **VPort**

## Сборка и запуск
Требования: libcli.
Сборка: `make`.
Запуск:
```
./v_switch 192.168.10.2
sudo ./vs_port 192.168.10.2
```
В качестве опций можно указать порт (по умолчанию 5555), режим подробной печати `-v`, "демонизацию" `-d` и т.д.

## Развёртывание
Т.к. при работе на одном хосте может присутствовать лишний траффик, а также в ядро Линукс может пересылать IP пакеты напрямую между интерфейсами, то для тестирования использовались виртуальные машины Virtualbox с изолированной внутренней сетью.

На одной из машин поднимался сервер, а на других - клиенты. По умолчанию vs\_port не назначает IP адрес, если необходимо, его можно добавить командой `sudo ip addr add 10.1.1.102/24 dev vs_port0`.

Для отправки пакетов использовалась программа `mausezahn`, входящая в пакет `netsniff-ng`.

## CLI интерфейс
В `v_switch` начата реализация зачаточного интерфейса командной строки с использованием libCLI. По умолчанию сервер прослушивает порт 12345, для доступа можно использовать telnet.
